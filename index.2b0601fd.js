class t{constructor(t,e,r,i){this.x=t,this.y=e,this.z=r,this.w=i}equals(t){return v.numberEquals(t.x,this.x)&&v.numberEquals(t.y,this.y)&&v.numberEquals(t.z,this.z)&&v.numberEquals(t.w,this.w)}}class e{constructor(t,e,r){this.x=t,this.y=e,this.z=r,this.w=1}equals(t){return v.numberEquals(t.x,this.x)&&v.numberEquals(t.y,this.y)&&v.numberEquals(t.z,this.z)&&v.numberEquals(t.w,this.w)}}class r{constructor(t,e,r){this.x=t,this.y=e,this.z=r,this.w=0}equals(t){return v.numberEquals(t.x,this.x)&&v.numberEquals(t.y,this.y)&&v.numberEquals(t.z,this.z)&&v.numberEquals(t.w,this.w)}}class i{constructor(t,e,r){this.r=t,this.g=e,this.b=r}equals(t){return v.numberEquals(t.r,this.r)&&v.numberEquals(t.g,this.g)&&v.numberEquals(t.b,this.b)}}class s{constructor(t,e){this.position=t,this.velocity=e}}class n{constructor(t,e){this.w=t,this.h=e,this.plane=Array(e);for(let e=0;e<this.plane.length;e++)this.plane[e]=Array(t);for(let r=0;r<e;r++)for(let e=0;e<t;e++)this.plane[r][e]=new i(0,0,0)}fill(t){for(let e=0;e<this.plane.length;e++)for(let r=0;r<this.plane[e].length;r++)this.plane[e][r]=t}setPixel(t,e,r){this.plane[r][e]=new i(t.r,t.g,t.b)}getPixel(t,e){return this.plane[e][t]?new i(this.plane[e][t].r,this.plane[e][t].g,this.plane[e][t].b):this.plane[e][t]}}class a{constructor(t,e,r){this.rows=e,this.columns=r,this.matrix=Array(e);for(let t=0;t<e;t++)this.matrix[t]=Array(r);let i=0;for(let s=0;s<e;s++)for(let e=0;e<r;e++)this.matrix[s][e]=t[i],i+=1}getNumber(t,e){return void 0!=this.matrix[t][e]||null!=this.matrix[t][e]?this.matrix[t][e]:NaN}setNumber(t,e,r){this.matrix[t][e]=r}getRows(){return this.rows}getColumns(){return this.columns}getSize(){return this.rows*this.columns}equals(t){if(this.rows!==t.getRows()&&this.columns!==t.getColumns())return!1;for(let e=0;e<this.rows;e++)for(let r=0;r<this.columns;r++)if(!v.numberEquals(this.matrix[e][r],t.getNumber(e,r)))return!1;return!0}}class o{constructor(t,e){this.origin=t,this.direction=e}getOrigin(){return new e(this.origin.x,this.origin.y,this.origin.z)}getDirection(){return new r(this.direction.x,this.direction.y,this.direction.z)}equals(t){return!!t&&this.origin.equals(t.getOrigin())&&this.direction.equals(t.getDirection())}}class l{constructor(){this.parent=null,this.matrix=R.createIdentityMatrix(4),this.material=R.createDefaultMaterial(),this.id=R.uuid()}getId(){return this.id}getTransform(){return this.matrix}setTransform(t){this.matrix=t}getMaterial(){return this.material}setMaterial(t){this.material=t}getParent(){return this.parent}normalAt(t){let e=this.world_to_object(t),r=this.local_normal_at(e);return this.normal_to_world(r)}intersect(t){let e=v.transform(t,v.inverse(this.getTransform()));return this.local_intersect(e)}world_to_object(t){return v.multiplyMatrixWithPoint(v.inverse(this.getTransform()),t)}normal_to_world(t){return t=v.multiplyMatrixWithVector(v.transpose(v.inverse(this.getTransform())),t),t=v.normalize(t)}worldToObject(t){return this.parent&&(t=this.parent.worldToObject(t)),v.multiplyMatrixWithPoint(v.inverse(this.getTransform()),t)}normalToWorld(t){return(t=v.multiplyMatrixWithVector(v.transpose(v.inverse(this.getTransform())),t)).w=0,t=v.normalize(t),this.parent&&(t=this.parent.normalToWorld(t)),t}normal_at(t){let e=this.worldToObject(t),r=this.local_normal_at(e);return this.normalToWorld(r)}equals(t){return this.material.equals(t.getMaterial())&&this.matrix.equals(t.getTransform())}}class h extends l{constructor(t=new e(0,0,0)){super(),this.savedRay=null}local_normal_at(t){return new r(t.x,t.y,t.z)}local_intersect(t){return this.savedRay=t,new w}}class c extends l{constructor(t=new e(0,0,0)){super()}local_normal_at(t){return new r(0,1,0)}local_intersect(t){return 1e-38>Math.abs(t.getDirection().y)?new w:new w(new d(-t.getOrigin().y/t.getDirection().y,this))}}class u extends l{constructor(t=new e(0,0,0)){super(),this.origin=t}local_normal_at(t){return v.substractPoints(t,this.origin)}local_intersect(t){let e=v.substractVectors(new r(t.getOrigin().x,t.getOrigin().y,t.getOrigin().z),new r(0,0,0)),i=v.dotProduct(t.getDirection(),t.getDirection()),s=2*v.dotProduct(t.getDirection(),e),n=Math.pow(s,2)-4*i*(v.dotProduct(e,e)-1);if(n<0)return new w;let a=(-s-Math.sqrt(n))/(2*i),o=(-s+Math.sqrt(n))/(2*i);return new w(new d(a,this),new d(o,this))}}class g extends l{constructor(){super()}local_normal_at(t){let e=Math.max(Math.abs(t.x),Math.abs(t.y),Math.abs(t.z));return e===Math.abs(t.x)?new r(t.x,0,0):e===Math.abs(t.y)?new r(0,t.y,0):new r(0,0,t.z)}local_intersect(t){let[e,r]=this.checkAxis(t.getOrigin().x,t.getDirection().x),[i,s]=this.checkAxis(t.getOrigin().y,t.getDirection().y),[n,a]=this.checkAxis(t.getOrigin().z,t.getDirection().z),o=Math.max(e,i,n),l=Math.min(r,s,a);return o>l?new w:new w(new d(o,this),new d(l,this))}checkAxis(t,e){let r,i;let s=-1-t,n=1-t;if(Math.abs(e)>=1e-4?(r=s/e,i=n/e):(r=s*Number.POSITIVE_INFINITY,i=n*Number.POSITIVE_INFINITY),r>i){let t=r;r=i,i=t}return[r,i]}}class m extends l{constructor(t=Number.NEGATIVE_INFINITY,e=Number.POSITIVE_INFINITY,r=!1){super(),this.minimum=t,this.maximum=e,this.closed=r}local_normal_at(t){let e=Math.pow(t.x,2)+Math.pow(t.z,2);return e<1&&t.y>=this.maximum-1e-4?new r(0,1,0):e<1&&t.y<=this.minimum+1e-4?new r(0,-1,0):new r(t.x,0,t.z)}local_intersect(t){let e=Math.pow(t.getDirection().x,2)+Math.pow(t.getDirection().z,2);if(1e-4>Math.abs(e))return this.intersectCaps(t);let r=2*t.getOrigin().x*t.getDirection().x+2*t.getOrigin().z*t.getDirection().z,i=Math.pow(r,2)-4*e*(Math.pow(t.getOrigin().x,2)+Math.pow(t.getOrigin().z,2)-1);if(i<0)return new w;let s=(-r-Math.sqrt(i))/(2*e),n=(-r+Math.sqrt(i))/(2*e);if(s>n){let t=s;s=n,n=t}let a=[],o=t.getOrigin().y+s*t.getDirection().y;this.minimum<o&&o<this.maximum&&a.push(new d(s,this));let l=t.getOrigin().y+n*t.getDirection().y;return this.minimum<l&&l<this.maximum&&a.push(new d(n,this)),a.push(...this.intersectCaps(t).getIntersections()),new w(...a)}checkCap(t,e){return Math.pow(t.getOrigin().x+e*t.getDirection().x,2)+Math.pow(t.getOrigin().z+e*t.getDirection().z,2)<=1}intersectCaps(t){let e=[];if(!this.closed||1e-4>Math.abs(t.getDirection().y))return new w;let r=(this.minimum-t.getOrigin().y)/t.getDirection().y;return this.checkCap(t,r)&&e.push(new d(r,this)),r=(this.maximum-t.getOrigin().y)/t.getDirection().y,this.checkCap(t,r)&&e.push(new d(r,this)),new w(...e)}}class p extends l{constructor(t=Number.NEGATIVE_INFINITY,e=Number.POSITIVE_INFINITY,r=!1){super(),this.minimum=t,this.maximum=e,this.closed=r}local_normal_at(t){let e=Math.pow(t.x,2)+Math.pow(t.z,2);if(e<1&&t.y>=this.maximum-1e-4)return new r(0,1,0);if(e<1&&t.y<=this.minimum+1e-4)return new r(0,-1,0);let i=Math.sqrt(Math.pow(t.x,2)+Math.pow(t.z,2));return t.y>0&&(i=-i),new r(t.x,i,t.z)}local_intersect(t){let e=Math.pow(t.getDirection().x,2)-Math.pow(t.getDirection().y,2)+Math.pow(t.getDirection().z,2),r=2*t.getOrigin().x*t.getDirection().x-2*t.getOrigin().y*t.getDirection().y+2*t.getOrigin().z*t.getDirection().z,i=Math.pow(r,2)-4*e*(Math.pow(t.getOrigin().x,2)-Math.pow(t.getOrigin().y,2)+Math.pow(t.getOrigin().z,2));if(i<0)return new w;let s=(-r-Math.sqrt(i))/(2*e),n=(-r+Math.sqrt(i))/(2*e);if(s>n){let t=s;s=n,n=t}let a=new w,o=t.getOrigin().y+s*t.getDirection().y;this.minimum<o&&o<this.maximum&&a.getIntersections().push(new d(s,this));let l=t.getOrigin().y+n*t.getDirection().y;return this.minimum<l&&l<this.maximum&&a.getIntersections().push(new d(n,this)),a.getIntersections().push(...this.intersectCaps(t,a).getIntersections()),a}checkCap(t,e,r){return Math.pow(t.getOrigin().x+e*t.getDirection().x,2)+Math.pow(t.getOrigin().z+e*t.getDirection().z,2)<=Math.pow(r,2)}intersectCaps(t,e){if(!this.closed||1e-4>Math.abs(t.getDirection().y))return e;let r=(this.minimum-t.getOrigin().y)/t.getDirection().y;return this.checkCap(t,r,this.minimum)&&e.getIntersections().push(new d(r,this)),r=(this.maximum-t.getOrigin().y)/t.getDirection().y,this.checkCap(t,r,this.maximum)&&e.getIntersections().push(new d(r,this)),e}}class d{constructor(t,e){this.t=t,this.shape=e}getT(){return this.t}getShape(){return this.shape}equals(t){return t.getT()===this.t&&t.getShape().equals(this.shape)}}class w{constructor(...t){this.intersections=t}getCount(){return this.intersections.length}getIntersections(){return this.intersections}getIntersectionAt(t){return this.intersections[t]}}class x{constructor(t,e){this.position=t,this.intensity=e}getIntensity(){return R.createColor(this.intensity.r,this.intensity.g,this.intensity.b)}getPosition(){return R.createPoint(this.position.x,this.position.y,this.position.z)}equals(t){return this.position.equals(t.position)&&this.intensity.equals(t.intensity)}}class f extends l{constructor(t=[]){super(),this.shapes=t}getShapes(){return this.shapes}setShapes(t){this.shapes=t}local_normal_at(t){throw Error("Not implemented")}local_intersect(t){let e=new w;return this.shapes.forEach(r=>{let i=r.intersect(t);e.getIntersections().push(...i.getIntersections())}),e.getIntersections().sort((t,e)=>t.getT()-e.getT()),e}equals(t){if(this.shapes.length!==t.shapes.length)return!1;for(let e=0;e<this.shapes.length;e++)if(!this.shapes[e].equals(t.shapes[e]))return!1;return!0}addChild(t){t.parent=this,this.shapes.push(t)}}class y{constructor(t=.1,e=.9,r=.9,s=200,n=new i(1,1,1),a=0,o=0,l=1){if(this.ambient=t,this.diffuse=e,this.specular=r,this.shininess=s,this.color=n,this.reflective=a,this.transparency=o,this.refractiveIndex=l,t<0||e<0||r<0||s<0)throw Error("Material value < 0 is invalid")}getAmbient(){return this.ambient}setAmbient(t){this.ambient=t}getDiffuse(){return this.diffuse}setDiffuse(t){this.diffuse=t}getSpecular(){return this.specular}setSpecular(t){this.specular=t}getShininess(){return this.shininess}setShininess(t){this.shininess=t}getColor(){return R.createColor(this.color.r,this.color.g,this.color.b)}setColor(t){this.color=t}getReflective(){return this.reflective}setReflective(t){this.reflective=t}getTransparency(){return this.transparency}setTransparency(t){this.transparency=t}getRefractiveIndex(){return this.refractiveIndex}setRefractiveIndex(t){this.refractiveIndex=t}equals(t){return v.numberEquals(t.ambient,this.ambient)&&v.numberEquals(t.diffuse,this.diffuse)&&v.numberEquals(t.specular,this.specular)&&v.numberEquals(t.shininess,this.shininess)&&v.numberEquals(t.reflective,this.reflective)&&v.numberEquals(t.transparency,this.transparency)&&v.numberEquals(t.refractiveIndex,this.refractiveIndex)&&t.color.equals(this.color)}}class M{constructor(t=null,e=[]){this.lightSource=t,this.shapes=e}getShapeAt(t){return this.shapes[t]}getShapes(){return this.shapes}getLightSource(){return this.lightSource}setLightSource(t){this.lightSource=t}setShapes(t){this.shapes=t}intersect(t){let e=[];return this.shapes.forEach(r=>{let i=r.intersect(t);e.push(...i.getIntersections())}),e.sort((t,e)=>t.getT()-e.getT()),new w(...e)}contains(t){let e=!1;return this.shapes.forEach(r=>{if(r.equals(t)){e=!0;return}}),e}}class b{constructor(t,e,r,i,s,n,a,o,l,h,c){this.t=t,this.object=e,this.point=r,this.overPoint=i,this.underPoint=s,this.eyeV=n,this.normalV=a,this.inside=o,this.reflectV=l,this.n1=h,this.n2=c}getT(){return this.t}getObject(){return this.object}getPoint(){return this.point}getEyeV(){return this.eyeV}getNormalV(){return this.normalV}isInside(){return this.inside}getOverPoint(){return this.overPoint}getUnderPoint(){return this.underPoint}getReflectV(){return this.reflectV}getN1(){return this.n1}getN2(){return this.n2}}class z{constructor(t,e,r,i=R.createIdentityMatrix(4)){this.hsize=t,this.vsize=e,this.fieldOfView=r,this.transform=i,this.pixelSize=-1,this.halfWidth=-1,this.halfHeight=-1,this.calculatePixelSize()}getHSize(){return this.hsize}getVSize(){return this.vsize}getFieldOfView(){return this.fieldOfView}getTransform(){return this.transform}setTranform(t){this.transform=t}getPixelSize(){return this.pixelSize}getHalfWidth(){return this.halfWidth}getHalfHeight(){return this.halfHeight}calculatePixelSize(){let t=Math.tan(this.fieldOfView/2),e=this.hsize/this.vsize;e>=1?(this.halfWidth=t,this.halfHeight=t/e):(this.halfWidth=t*e,this.halfHeight=t),this.pixelSize=2*this.halfWidth/this.hsize}}new i(0,0,0),new i(1,1,1);class v{static addPoints(t,e){return R.createPoint(t.x+e.x,t.y+e.y,t.z+e.z)}static substractPoints(t,e){return R.createTuple(t.x-e.x,t.y-e.y,t.z-e.z,t.w-e.w)}static substractVectors(t,e){return R.createTuple(t.x-e.x,t.y-e.y,t.z-e.z,t.w-e.w)}static substractVectorFromPoint(t,e){return R.createTuple(t.x-e.x,t.y-e.y,t.z-e.z,t.w-e.w)}static addTuples(t,e){return R.createTuple(t.x+e.x,t.y+e.y,t.z+e.z,t.w+e.w)}static substractTuples(t,e){return R.createPoint(t.x-e.x,t.y-e.y,t.z-e.z)}static addVectors(t,e){return R.createTuple(t.x+e.x,t.y+e.y,t.z+e.z,t.w+e.w)}static addColors(t,e){return R.createColor(t.r+e.r,t.g+e.g,t.b+e.b)}static substractColors(t,e){return R.createColor(t.r-e.r,t.g-e.g,t.b-e.b)}static multiplyColor(t,e){return R.createColor(t.r*e,t.g*e,t.b*e)}static multiplyColors(t,e){return R.createColor(t.r*e.r,t.g*e.g,t.b*e.b)}static inverseVector(t){return R.createTuple(0-t.x,0-t.y,0-t.z,0-t.w)}static inverseTuple(t){return R.createTuple(0-t.x,0-t.y,0-t.z,0-t.w)}static multiplyTuple(t,e){return R.createTuple(t.x*e,t.y*e,t.z*e,t.w*e)}static multiplyPoint(t,e){return R.createPoint(t.x*e,t.y*e,t.z*e)}static multiplyVector(t,e){return R.createVector(t.x*e,t.y*e,t.z*e)}static divideTuple(t,e){return R.createTuple(t.x/e,t.y/e,t.z/e,t.w/e)}static magnitudeOf(t){return Math.sqrt(Math.pow(t.x,2)+Math.pow(t.y,2)+Math.pow(t.z,2)+Math.pow(t.w,2))}static normalize(t){return this.divideTuple(t,this.magnitudeOf(t))}static dotProduct(t,e){return t.x*e.x+t.y*e.y+t.z*e.z+t.w*e.w}static crossProduct(t,e){return new r(t.y*e.z-t.z*e.y,t.z*e.x-t.x*e.z,t.x*e.y-t.y*e.x)}static multiplyMatrix(t,e){let r=[];for(let i=0;i<t.getRows();i++)for(let s=0;s<e.getColumns();s++){let n=0;for(let r=0;r<t.getColumns();r++)n+=t.getNumber(i,r)*e.getNumber(r,s);r.push(n)}return R.createMatrix(r,t.getRows(),e.getColumns())}static transpose(t){let e=[];for(let r=0;r<t.getRows();r++)for(let i=0;i<t.getColumns();i++)e.push(t.getNumber(i,r));return R.createMatrix(e,t.getColumns(),t.getRows())}static getDeterminant(t){if(2===t.getRows()&&2===t.getColumns())return t.getNumber(0,0)*t.getNumber(1,1)-t.getNumber(0,1)*t.getNumber(1,0);let e=0;for(let r=0;r<t.getColumns();r++)e+=t.getNumber(0,r)*this.getCofactor(t,0,r);return e}static isInvertible(t){return 0!==this.getDeterminant(t)}static inverse(t){if(!this.isInvertible(t))throw Error("This matrix is not invertible");let e=this.nullMatrix(t),r=this.getDeterminant(t);for(let i=0;i<t.getRows();i++)for(let s=0;s<t.getColumns();s++){let n=this.getCofactor(t,i,s);e.setNumber(s,i,n/r)}return e}static getCofactor(t,e,r){let i=this.getMinor(t,e,r);return this.isOdd(e+r)?0-i:i}static isOdd(t){return t%2==1}static getMinor(t,e,r){let i=this.getSubmatrix(t,e,r);return this.getDeterminant(i)}static getSubmatrix(t,e,r){let i=[];for(let s=0;s<t.getRows();s++)if(s!==e)for(let e=0;e<t.getColumns();e++)e!==r&&i.push(t.getNumber(s,e));return R.createMatrix(i,t.getRows()-1,t.getColumns()-1)}static cloneMatrix(t){let e=[];for(let r=0;r<t.getRows();r++)for(let i=0;i<t.getColumns();i++)e.push(t.getNumber(r,i));return R.createMatrix(e,t.getRows(),t.getColumns())}static multiplyMatrixWithPoint(t,r){let i=R.createMatrix([r.x,r.y,r.z,r.w],4,1),s=this.multiplyMatrix(t,i);return new e(s.getNumber(0,0),s.getNumber(1,0),s.getNumber(2,0))}static multiplyMatrixWithVector(t,e){let i=R.createMatrix([e.x,e.y,e.z,e.w],4,1),s=this.multiplyMatrix(t,i);return new r(s.getNumber(0,0),s.getNumber(1,0),s.getNumber(2,0))}static nullMatrix(t){let e=[];for(let r=0;r<t.getRows();r++)for(let r=0;r<t.getColumns();r++)e.push(0);return R.createMatrix(e,t.getRows(),t.getColumns())}static tick(t,e){return new s(this.addTuples(e.position,e.velocity),this.addVectors(e.velocity,this.addVectors(t.gravity,t.wind)))}static getRadians(t){return t*Math.PI/180}static getRayPosition(t,e){return this.addTuples(t.getOrigin(),this.multiplyVector(t.getDirection(),e))}static numberEquals(t,e){return 1e-4>Math.abs(t-e)}static getHit(t){let e=[];for(let r of t.getIntersections())r.getT()>=0&&e.push(r);return(e.sort((t,e)=>t.getT()-e.getT()),0===e.length)?null:e[0]}static transform(t,e){return R.createRay(this.multiplyMatrixWithPoint(e,t.getOrigin()),this.multiplyMatrixWithVector(e,t.getDirection()))}static normalAtPlane(t,e){let r=v.multiplyMatrixWithPoint(v.inverse(t.getTransform()),e),i=t.normalAt(r),s=v.multiplyMatrixWithVector(v.transpose(v.inverse(t.getTransform())),i);return s.w=0,v.normalize(s)}static normalAt(t,e){if(t instanceof c)return this.normalAtPlane(t,e);let r=R.createPoint(0,0,0),i=v.multiplyMatrixWithPoint(v.inverse(t.getTransform()),e),s=v.substractPoints(i,r),n=v.multiplyMatrixWithVector(v.transpose(v.inverse(t.getTransform())),s);return n.w=0,v.normalize(n)}static reflect(t,e){let r=2*v.dotProduct(t,e),i=v.multiplyVector(e,r);return v.substractVectors(t,i)}static lighting(t,e,r,i,s,n,a=!1){let o;o=t.pattern?t.pattern.colorAtShape(e,i):t.getColor();let l=v.normalize(v.substractPoints(r.getPosition(),i)),h=v.multiplyColor(o,t.getAmbient()),c=v.dotProduct(l,n);if(c<0||a)o=h;else{let e=v.multiplyColor(o,t.getDiffuse()*c),i=v.reflect(v.inverseVector(l),n),a=v.dotProduct(i,s);if(a<=0)o=v.addColors(h,e);else{let i=Math.pow(a,t.getShininess()),s=v.multiplyColor(r.getIntensity(),t.getSpecular()*i);o=v.addColors(v.addColors(h,e),s)}}return a?h:o}static prepareComputations(t,e,r=new w){let i=v.getRayPosition(e,t.getT()),s=v.multiplyVector(e.getDirection(),-1),n=v.normalAt(t.getShape(),i),a=!1;0>v.dotProduct(n,s)&&(a=!0,n=v.multiplyVector(n,-1));let o=v.addTuples(i,v.multiplyPoint(n,1e-4)),l=v.substractTuples(i,v.multiplyPoint(n,1e-4)),h=v.reflect(e.getDirection(),n),c=1,u=1,g=[];for(let e of r.getIntersections())if(e===t&&(c=0===g.length?1:g[g.length-1].getMaterial().getRefractiveIndex()),g.includes(e.getShape())?g.splice(g.indexOf(e.getShape()),1):g.push(e.getShape()),e===t){u=0===g.length?1:g[g.length-1].getMaterial().getRefractiveIndex();break}return new b(t.getT(),t.getShape(),i,o,l,s,n,a,h,c,u)}static shadeHit(t,e,r=5){let i=t.getLightSource();if(i){let s=v.isShadowed(t,e.getOverPoint()),n=v.lighting(e.getObject().getMaterial(),e.getObject(),i,e.getOverPoint(),e.getEyeV(),e.getNormalV(),s),a=v.reflectedColor(t,e,r),o=v.refractedColor(t,e,r),l=e.getObject().getMaterial();if(!(l.getReflective()>0&&l.getTransparency()>0))return v.addColors(v.addColors(n,a),o);{let t=v.schlick(e);return a=v.multiplyColor(a,t),o=v.multiplyColor(o,1-t),v.addColors(v.addColors(n,a),o)}}throw Error("Unable to calculate shade without lightSource in world")}static colorAt(t,e,r=5){let s=t.intersect(e),n=v.getHit(s);if(!n)return new i(0,0,0);{let i=v.prepareComputations(n,e);return v.shadeHit(t,i,r)}}static viewTransform(t,e,r){let i=v.normalize(v.substractPoints(e,t)),s=v.normalize(r),n=v.crossProduct(i,s),a=v.crossProduct(n,i),o=[n.x,n.y,n.z,0,a.x,a.y,a.z,0,-i.x,-i.y,-i.z,0,0,0,0,1],l=R.createMatrix(o,4,4);return v.multiplyMatrix(l,R.getTranslationMatrix(-t.x,-t.y,-t.z))}static rayForPixel(t,r,i){let s=(r+.5)*t.getPixelSize(),n=(i+.5)*t.getPixelSize(),a=t.getHalfWidth()-s,o=t.getHalfHeight()-n,l=v.multiplyMatrixWithPoint(v.inverse(t.getTransform()),new e(a,o,-1)),h=v.multiplyMatrixWithPoint(v.inverse(t.getTransform()),new e(0,0,0)),c=v.normalize(v.substractPoints(l,h));return R.createRay(h,c)}static isShadowed(t,e){let r=t.getLightSource();if(r){let i=v.substractPoints(r.getPosition(),e),s=v.magnitudeOf(i),n=v.normalize(i),a=R.createRay(e,n),o=t.intersect(a),l=v.getHit(o);return!!(l&&l.getT()<s)}throw Error("Error there is no light source is present in this world")}static reflectedColor(t,e,r){if(r<=0||0===e.getObject().getMaterial().getReflective())return new i(0,0,0);let s=R.createRay(e.getOverPoint(),e.getReflectV()),n=v.colorAt(t,s,r-1);return v.multiplyColor(n,e.getObject().getMaterial().getReflective())}static refractedColor(t,e,r){if(r<=0||0===e.getObject().getMaterial().getTransparency())return new i(0,0,0);let s=e.getN1()/e.getN2(),n=v.dotProduct(e.getEyeV(),e.getNormalV()),a=Math.pow(s,2)*(1-Math.pow(n,2));if(a>1)return new i(0,0,0);let o=v.substractVectors(v.multiplyVector(e.getNormalV(),s*n-Math.sqrt(1-a)),v.multiplyVector(e.getEyeV(),s)),l=R.createRay(e.getUnderPoint(),o),h=v.colorAt(t,l,r-1);return v.multiplyColor(h,e.getObject().getMaterial().getTransparency())}static schlick(t){let e=v.dotProduct(t.getEyeV(),t.getNormalV());if(t.getN1()>t.getN2()){let r=Math.pow(t.getN1()/t.getN2(),2)*(1-Math.pow(e,2));if(r>1)return 1;e=Math.sqrt(1-r)}let r=Math.pow((t.getN1()-t.getN2())/(t.getN1()+t.getN2()),2);return r+(1-r)*Math.pow(1-e,5)}}class P{constructor(){this.matrix=R.createIdentityMatrix(4)}setTransform(t){this.matrix=t}colorAtShape(t,e){let r=t.worldToObject(e),i=v.multiplyMatrixWithPoint(v.inverse(this.matrix),r);return this.colorAt(i)}}class T extends P{constructor(){super()}colorAt(t){return new i(t.x,t.y,t.z)}}class I extends P{constructor(t,e){super(),this.a=t,this.b=e}colorAt(t){return Math.floor(t.x)%2==0?this.a:this.b}}class S extends P{constructor(t,e){super(),this.a=t,this.b=e}colorAt(t){let e=v.substractColors(this.b,this.a),r=t.x-Math.floor(t.x);return v.addColors(this.a,v.multiplyColor(e,r))}colorAtShape(t,e){let r=v.multiplyMatrixWithPoint(v.inverse(t.getTransform()),e),i=v.multiplyMatrixWithPoint(v.inverse(this.matrix),r);return this.colorAt(i)}}class C extends P{constructor(t,e){super(),this.a=t,this.b=e}colorAt(t){return Math.floor(Math.sqrt(t.x*t.x+t.z*t.z))%2==0?this.a:this.b}}class N extends P{constructor(t,e){super(),this.a=t,this.b=e}colorAt(t){return(Math.floor(t.x)+Math.floor(t.y)+Math.floor(t.z))%2==0?this.a:this.b}}class D extends P{constructor(t,e){super(),this.a=t,this.b=e}colorAt(t){return(Math.floor(t.x)+Math.floor(t.y)+Math.floor(t.z))%2==0?this.a.colorAt(t):this.b.colorAt(t)}}class E extends P{constructor(t,e){super(),this.a=t,this.b=e}colorAt(t){let e=this.a.colorAt(t),r=this.b.colorAt(t);return v.addColors(e,r)}}class O extends P{constructor(t){super(),this.pattern=t}colorAt(t){let r=new e(t.x+Math.sin(t.x*t.y*t.z),t.y+Math.sin(t.x*t.y*t.z),t.z+Math.sin(t.x*t.y*t.z));return this.pattern.colorAt(r)}}class R{static createMatrix(t,e,r){return new a(t,e,r)}static getTranslationMatrix(t,e,r){let i=this.createIdentityMatrix(4);return i.setNumber(0,3,t),i.setNumber(1,3,e),i.setNumber(2,3,r),i}static getScalingMatrix(t,e,r){let i=this.createIdentityMatrix(4);return i.setNumber(0,0,t),i.setNumber(1,1,e),i.setNumber(2,2,r),i}static getRotationMatrixX(t){let e=this.createIdentityMatrix(4);return e.setNumber(1,1,Math.cos(t)),e.setNumber(1,2,-Math.sin(t)),e.setNumber(2,1,Math.sin(t)),e.setNumber(2,2,Math.cos(t)),e}static getRotationMatrixY(t){let e=this.createIdentityMatrix(4);return e.setNumber(0,0,Math.cos(t)),e.setNumber(0,2,Math.sin(t)),e.setNumber(2,0,-Math.sin(t)),e.setNumber(2,2,Math.cos(t)),e}static getRotationMatrixZ(t){let e=this.createIdentityMatrix(4);return e.setNumber(0,0,Math.cos(t)),e.setNumber(0,1,-Math.sin(t)),e.setNumber(1,0,Math.sin(t)),e.setNumber(1,1,Math.cos(t)),e}static getShearingMatrix(t,e,r,i,s,n){let a=this.createIdentityMatrix(4);return a.setNumber(0,1,t),a.setNumber(0,2,e),a.setNumber(1,0,r),a.setNumber(1,2,i),a.setNumber(2,0,s),a.setNumber(2,1,n),a}static createIdentityMatrix(t){if(t<0)throw Error("Size must be positive");let e=[];for(let r=0;r<t;r++)for(let i=0;i<t;i++)r===i?e.push(1):e.push(0);return new a(e,t,t)}static createTuple(i,s,n,a){return v.numberEquals(a,1)?new e(i,s,n):v.numberEquals(a,0)?new r(i,s,n):new t(i,s,n,a)}static createPoint(t,r,i){return new e(t,r,i)}static createVector(t,e,i){return new r(t,e,i)}static createColor(t,e,r){return new i(t,e,r)}static createCanvas(t,e){return new n(t,e)}static createRay(t,e){return new o(t,e)}static createIntersection(t,e){return new d(t,e)}static createSphere(){return new u}static createPlane(){return new c}static createTestShape(){return new h}static uuid(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){let e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})}static createPointLight(t,e){return new x(t,e)}static createDefaultMaterial(){return new y}static createMaterial(t,e,r,i,s,n,a,o){return new y(t,e,r,i,s,n,a,o)}static createWorld(){return new M}static createDefaultWorld(){let t=R.createPointLight(new e(-10,10,-10),new i(1,1,1)),r=new u;r.setMaterial(new y(.1,.7,.2,200,new i(.8,1,.6)));let s=new u;return s.setTransform(R.getScalingMatrix(.5,.5,.5)),new M(t,[r,s])}static createCamera(t,e,r){return new z(t,e,r)}static buildStripePattern(t,e){return new I(t,e)}static createGradientPattern(t,e){return new S(t,e)}static createRingPattern(t,e){return new C(t,e)}static createCheckersPattern(t,e){return new N(t,e)}static createNestedStripeAndGradientPattern(t,e){return new D(this.buildStripePattern(t,e),this.createGradientPattern(t,e))}static createBlendedGradientAndRingPattern(t,e){return new E(this.createGradientPattern(t,e),this.createRingPattern(t,e))}static createPerturbedGradientAndRingPattern(t,e){let r=this.createGradientPattern(t,e);return this.createPerturbedPattern(r)}static createNestedPattern(t,e){return new D(t,e)}static createTestPattern(){return new T}static createGlassSphere(){let t=this.createSphere();return t.setTransform(this.getScalingMatrix(.5,.5,.5)),t.getMaterial().setTransparency(1),t.getMaterial().setRefractiveIndex(1.5),t}static createCube(){return new g}static createCylinder(){return new m}static createCone(){return new p}static createGroup(){return new f}static createPerturbedPattern(t){return new O(t)}}class q{static getPpmString(t){return this.getPpmHeader(t)+"\n"+this.getPpmBody(t)}static getPpmHeader(t){return`P3
${t.w} ${t.h}
255`}static getPpmBody(t){let e="";for(let r=0;r<t.h;r++){let i="",s=0;for(let e=0;e<t.w;e++){let n=this.getRED(t.getPixel(e,r));s+n.length>70&&(i=i.trim()+"\n",s=0),i+=n+" ",s+=(n+" ").length;let a=this.getGREEN(t.getPixel(e,r));s+a.length>70&&(i=i.trim()+"\n",s=0),i+=a+" ",s+=(a+" ").length;let o=this.getBLUE(t.getPixel(e,r));s+o.length>70&&(i=i.trim()+"\n",s=0),i+=o+" ",s+=(o+" ").length}e+=i.trim()+"\n"}return e.trim()+"\n"}static getRED(t){let e=0;return t&&(e=Math.round(255*t.r)>255?255:Math.round(255*t.r)),`${e}`}static getGREEN(t){let e=0;return t&&(e=Math.round(255*t.g)>255?255:Math.round(255*t.g)),`${e}`}static getBLUE(t){let e=0;return t&&(e=Math.round(255*t.b)>255?255:Math.round(255*t.b)),`${e}`}static render(t,e){let r=R.createCanvas(t.getHSize(),t.getVSize());for(let i=0;i<t.getVSize();i++)for(let s=0;s<t.getHSize();s++){let n=v.rayForPixel(t,s,i),a=v.colorAt(e,n);r.setPixel(a,s,i)}return r}static renderOnRawImageData(t,e,r){for(let i=0;i<t.getVSize();i++)for(let s=0;s<t.getHSize();s++){let n=v.rayForPixel(t,s,i),a=v.colorAt(e,n);this.drawPixel(t.getVSize(),s,i,a,r)}}static renderOnRawImageDataSector(t,e,r,i,s,n,a){for(let o=n;o<a;o++)for(let n=i;n<s;n++){let i=v.rayForPixel(t,n,o),s=v.colorAt(e,i);this.drawPixel(t.getVSize(),n,o,s,r)}}static fillWithBlack(t,e,r){for(let i=0;i<r;i++)for(let s=0;s<e;s++){let e=4*(r*i+s);t[e+0]=30,t[e+1]=30,t[e+2]=30,t[e+3]=255}}static drawPixel(t,e,r,i,s){let n=4*(t*r+e);s[n+0]=Math.round(255*i.r),s[n+1]=Math.round(255*i.g),s[n+2]=Math.round(255*i.b),s[n+3]=255}}let V=new class{constructor(){this.size=600,this.sectorSize=this.size<100?Math.round(this.size/100*10):this.size/100*10,this.counterFrom_X=0,this.counterTo_X=this.sectorSize,this.counterFrom_Y=0,this.counterTo_Y=this.sectorSize,this.canvasId="raycasterCanvas",this.canvas=document.getElementById(this.canvasId),this.cancelRendering=!1,this.canvasImageData=null,this.rawImageData=null,this.ctx=null}initializeCanvasAndSizes(){if(this.canvas=document.getElementById(this.canvasId),this.canvas.width=this.size,this.canvas.height=this.size,this.ctx=this.canvas.getContext("2d"),!this.canvas||!this.ctx)throw Error(`There is no canvas with id ${this.canvasId} on this page.`);this.canvasImageData=this.ctx.createImageData(this.size,this.size),this.rawImageData=this.canvasImageData.data,this.fillCanvasWithBlack(),this.ctx.putImageData(this.canvasImageData,0,0),this.sectorSize=this.size<100?Math.round(this.size/100*10):this.size/100*10;let t=R.uuid(),e=this.canvas.parentNode;window.history.pushState({},t,`?uid=${t}`);var r=this;e&&e.addEventListener("mousedown",t=>{!function(t){t.preventDefault();let i=t.clientX;t.clientY;let s=e.offsetWidth,n=s/e.offsetHeight;function a(t){let r=t.clientX-i;t.clientY;let a=s+r;e.style.width=`${a}px`,e.style.height=`${a/n}px`}function o(){window.removeEventListener("mousemove",a),window.removeEventListener("mouseup",o)}window.addEventListener("mousemove",a),window.addEventListener("mouseup",o),window.addEventListener("mouseup",function t(e){e.preventDefault(),window.removeEventListener("mousemove",a),window.removeEventListener("mouseup",o),window.removeEventListener("mouseup",t),r.reset()})}(t)})}reset(){}fillCanvasWithBlack(){this.ctx&&this.rawImageData&&this.canvasImageData&&(q.fillWithBlack(this.rawImageData,this.size,this.size),this.ctx.putImageData(this.canvasImageData,0,0))}draw(t,s,n,a){let o=R.createPlane();o.setTransform(R.getTranslationMatrix(0,.01,0));let l=o.getMaterial();l.setColor(new i(1,.9,.9)),l.setSpecular(0),l.setReflective(.4),l.pattern=R.createBlendedGradientAndRingPattern(new i(1,0,0),new i(0,0,1)),o.setMaterial(l);let h=R.createSphere();h.setTransform(R.getTranslationMatrix(-.5,1,.5));let c=h.getMaterial();c.setDiffuse(0),c.setSpecular(1),c.setShininess(300),c.setReflective(4),c.setTransparency(.9),c.setRefractiveIndex(100),h.setMaterial(c);let u=R.createSphere();u.setTransform(v.multiplyMatrix(R.getTranslationMatrix(1.5,.5,-.5),R.getScalingMatrix(.5,.5,.5)));let g=u.getMaterial(),m=R.createGradientPattern(new i(1,0,0),new i(1,1,0));m.setTransform(R.getScalingMatrix(2,2,2)),g.setDiffuse(.7),g.setSpecular(.3),g.setReflective(.4),g.setReflective(.4),g.setTransparency(.7),g.pattern=m,u.setMaterial(g);let p=R.createSphere();p.setTransform(v.multiplyMatrix(R.getTranslationMatrix(-1.5,.33,-.75),R.getScalingMatrix(.33,.33,.33)));let d=p.getMaterial();d.setDiffuse(.7),d.setSpecular(.3),d.setReflective(.4),d.pattern=R.createNestedStripeAndGradientPattern(new i(1,1,0),new i(1,0,1)),d.pattern.setTransform(R.getScalingMatrix(.5,.5,.5)),p.setMaterial(d);let w=R.createGroup();w.addChild(h),w.addChild(u),w.addChild(p),w.setTransform(R.getScalingMatrix(.9,.9,.9));let x=R.createDefaultWorld(),f=R.createPointLight(new e(-10,10,-10),new i(1,1,1));x.setLightSource(f),x.setShapes([o,w]);let y=R.createCamera(this.size,this.size,Math.PI/3);y.setTranform(v.viewTransform(new e(0,1.5,-5),new e(0,1,0),new r(0,1,0))),this.rawImageData&&this.ctx&&this.canvasImageData&&(q.renderOnRawImageDataSector(y,x,this.rawImageData,t,s,n,a),this.ctx.putImageData(this.canvasImageData,0,0))}callBack(){this.draw(this.counterFrom_X,this.counterTo_X,this.counterFrom_Y,this.counterTo_Y);let t=this.counterTo_X===this.size,e=this.counterTo_Y===this.size;this.counterFrom_X=this.counterTo_X,this.counterTo_X+=this.sectorSize,t?t&&!e&&(this.counterFrom_X=0,this.counterTo_X=this.sectorSize,this.counterFrom_Y=this.counterTo_Y,this.counterTo_Y+=this.sectorSize,this.cancelRendering?this.initializeCanvasAndSizes():window.requestAnimationFrame(this.callBack.bind(this))):this.cancelRendering?this.initializeCanvasAndSizes():window.requestAnimationFrame(this.callBack.bind(this))}};V.initializeCanvasAndSizes(),V.callBack();
//# sourceMappingURL=index.2b0601fd.js.map
